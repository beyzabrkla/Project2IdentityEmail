@model Project2IdentityEmail.DTOs.SendMessageDTO
@{
    ViewData["Title"] = "Yeni Mesaj";
    Layout = "~/Views/Shared/_MailLayout.cshtml";
}
<style>
    /* Editörü Footer'ı itmeyecek şekilde kilitler */
    .cke_chrome {
        height: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        border: 1px solid #e9ecef !important;
    }

    .cke_inner {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden;
    }

    .cke_contents {
        flex: 1 !important;
        height: auto !important;
    }
</style>

<div class="page-wrapper">
    <div class="page-breadcrumb bg-white p-3 shadow-sm">
        <div class="row align-items-center">
            <div class="col-12">
                <div class="d-flex align-items-center">
                    <a href="/Dashboard/Index" class="mr-3 d-flex align-items-center justify-content-center"
                       style="width: 40px; height: 40px; background-color: #f3f3f5; border-radius: 50%;">
                        <i class="mdi mdi-chevron-left text-primary" style="font-size: 24px;"></i>
                    </a>
                    <div class="d-flex flex-column">
                        <h4 class="page-title mb-0 font-weight-bold" style="color: #3e3c59;">Yeni Mesaj Oluştur</h4>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0 bg-transparent" style="font-size: 12px;">
                                <li class="breadcrumb-item"><a href="/Dashboard/Index" class="text-muted">Ana Sayfa</a></li>
                                <li class="breadcrumb-item active text-dark" aria-current="page">Yeni Mesaj</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mail-content-container" style="display: flex; flex: 1; overflow: hidden; min-height: 0;">
        @await Component.InvokeAsync("MailLayoutSidebar")

        <div class="flex-grow-1 bg-white p-4 d-flex flex-column" style="min-height: 0; overflow: hidden;">
            <form class="d-flex flex-column h-100" style="min-height: 0;" asp-action="ComposeMail" asp-controller="Mail" method="post" enctype="multipart/form-data">

                @* ALICI - Yanıtla butonundan gelirse otomatik dolar *@
                <div class="form-group mb-2" style="flex: 0 0 auto;">
                    <input type="email" asp-for="ReceiverEmail" class="form-control rounded-pill border-light bg-light px-4"
                           placeholder="Kime (Email):"
                           value="@ViewBag.ReceiverMail"
                           style="height: 40px; border: 1px solid #e9ecef !important;">
                </div>

                @* KONU - Yanıtla butonundan gelirse otomatik dolar *@
                <div class="form-group mb-2" style="flex: 0 0 auto;">
                    <input type="text" asp-for="Subject" class="form-control rounded-pill border-light bg-light px-4"
                           placeholder="Konu:"
                           value="@ViewBag.Subject"
                           style="height: 40px; border: 1px solid #e9ecef !important;">
                </div>

                @* KATEGORİ *@
                <div class="form-group mb-2" style="flex: 0 0 auto;">
                    <select asp-for="CategoryId" class="form-control rounded-pill border-light bg-light px-4"
                            style="height: 40px; border: 1px solid #e9ecef !important; appearance: none;">
                        <option value="">Bir Kategori Seçin</option>
                        @if (ViewBag.Categories != null)
                        {
                            foreach (var item in (List<Project2IdentityEmail.Entities.Category>)ViewBag.Categories)
                            {
                                <option value="@item.Id">@item.CategoryName</option>
                            }
                        }
                    </select>
                </div>

                @* MESAJ İÇERİĞİ *@
                <div class="form-group mb-2" style="flex: 1; min-height: 0; display: flex; flex-direction: column;">
                    <textarea id="editor1" asp-for="Content">@ViewBag.Content</textarea>
                </div>

                @* Dosya Yükleme Alanı *@
                <div class="form-group mb-2 d-flex align-items-center">
                    <label for="fileUpload" class="btn btn-light border mr-2 mb-0" style="border-radius: 12px; cursor: pointer;">
                        <i class="mdi mdi-paperclip mr-1"></i> Dosya Ekle
                    </label>
                    @* id="fileUpload" olarak kalsın, scripti buna bağlayalım *@
                    <input type="file" id="fileUpload" name="Attachment" style="display: none;">
                    <span id="file-info" class="text-muted small">Dosya seçilmedi</span>
                </div>

                @* BUTONLAR *@
                <div class="d-flex justify-content-between align-items-center pt-3 border-top" style="flex: 0 0 auto;">
                    <div class="d-flex align-items-center">
                        <a href="/Mail/Inbox" class="text-muted mr-4 font-weight-bold" style="text-decoration: none; font-size: 14px;">Vazgeç</a>

                        <button type="submit" name="actionType" value="saveDraft" class="btn btn-light d-flex align-items-center px-4 mr-2"
                                style="height: 48px; border: 1px solid #d1d3e2; border-radius: 12px; font-weight: bold; color: #4e73df;">
                            <i class="mdi mdi-file-document-box-outline mr-2"></i> Taslaklara Kaydet
                        </button>

                        <button type="submit" name="actionType" value="send" class="btn btn-primary d-flex align-items-center px-4"
                                style="height: 48px; border: none; border-radius: 12px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,123,255,0.3);">
                            <i class="mdi mdi-send mr-2"></i> Gönder
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <script>
            document.getElementById('attachment').addEventListener('change', function(e) {
                const label = document.getElementById('file-label');
                const info = document.getElementById('file-info');
                if (this.files.length > 0) {
                    label.textContent = this.files[0].name;
                    label.className = "text-dark font-weight-bold";
                    info.textContent = this.files.length + " dosya hazır";
                    info.style.display = "block";
                }
            });
        </script>
    </div>

</div>
</div>
</div>

<script>
    if (typeof CKEDITOR !== 'undefined') {
            if (CKEDITOR.instances['editor1']) {
                CKEDITOR.instances['editor1'].destroy(true);
            }
            CKEDITOR.replace('editor1', {
                height: '100%',
                removePlugins: 'elementspath,resize',
                // Aşağıdaki toolbar kısmını bu şekilde güncelle:
                toolbar: [
                    { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike'] },
                    { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent'] },
                    { name: 'insert', items: ['Image', 'Table', 'HorizontalRule', 'SpecialChar'] }, // Image burada!
                    { name: 'styles', items: ['Font', 'FontSize', 'TextColor', 'BGColor'] },
                    { name: 'links', items: ['Link', 'Unlink'] }
                ],
                // Görsel yükleme desteği için (opsiyonel sunucu tarafı ayarı gerektirir)
                filebrowserUploadMethod: 'form'
            });
        }

        document.querySelector('form').addEventListener('submit', function() {
        // CKEditor'deki veriyi gizli olan textarea'ya (asp-for="Content") aktarır
        for (var instance in CKEDITOR.instances) {
            CKEDITOR.instances[instance].updateElement();
        }
    });

    // 'fileUpload' ID'li inputu dinliyoruz
    document.getElementById('fileUpload').addEventListener('change', function(e) {
        // İsmin yazılacağı span: 'file-info'
        const info = document.getElementById('file-info');

        if (this.files.length > 0) {
            // Seçilen ilk dosyanın adını yazdır
            info.textContent = this.files[0].name;
            info.className = "text-primary font-weight-bold small";
        } else {
            info.textContent = "Dosya seçilmedi";
            info.className = "text-muted small";
        }
    });
</script>